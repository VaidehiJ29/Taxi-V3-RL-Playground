<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Taxi-v3 Â· RL Playground</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@700;800&display=swap');

  :root {
    --bg:       #0a0a0f;
    --panel:    #12121a;
    --border:   #1e1e2e;
    --accent:   #f5c518;
    --green:    #39d353;
    --red:      #ff4757;
    --blue:     #4dabf7;
    --purple:   #cc5de8;
    --dim:      #3a3a52;
    --text:     #e0e0f0;
    --muted:    #6b6b8a;
    --cell:     44px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Space Mono', monospace;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 24px 16px;
    overflow-x: hidden;
  }

  /* â”€â”€ noise texture â”€â”€ */
  body::before {
    content: '';
    position: fixed; inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");
    pointer-events: none; z-index: 0;
  }

  h1 {
    font-family: 'Syne', sans-serif;
    font-size: clamp(2rem, 5vw, 3.5rem);
    font-weight: 800;
    letter-spacing: -1px;
    color: var(--accent);
    text-shadow: 0 0 40px rgba(245,197,24,.35);
    margin-bottom: 4px;
    position: relative; z-index: 1;
  }
  .subtitle {
    color: var(--muted); font-size: .78rem;
    letter-spacing: 3px; text-transform: uppercase;
    margin-bottom: 32px; position: relative; z-index: 1;
  }

  .layout {
    display: flex; gap: 24px; align-items: flex-start;
    flex-wrap: wrap; justify-content: center;
    position: relative; z-index: 1; width: 100%; max-width: 980px;
  }

  /* â”€â”€ Game Board â”€â”€ */
  .board-wrap {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 0 60px rgba(245,197,24,.07);
  }
  #grid {
    display: grid;
    grid-template-columns: repeat(5, var(--cell));
    grid-template-rows:    repeat(5, var(--cell));
    gap: 3px;
    position: relative;
  }
  .cell {
    width: var(--cell); height: var(--cell);
    background: #16162a;
    border-radius: 6px;
    display: flex; align-items: center; justify-content: center;
    font-size: 20px;
    transition: background .15s;
    position: relative;
    overflow: hidden;
  }
  .cell.wall-right::after {
    content:''; position:absolute; right:-2px; top:10%; height:80%; width:4px;
    background: var(--dim); border-radius:2px;
  }
  .cell.dest {
    background: rgba(57,211,83,.12);
    border: 1px solid rgba(57,211,83,.35);
    box-shadow: inset 0 0 12px rgba(57,211,83,.1);
  }
  .cell.passenger {
    background: rgba(77,171,247,.12);
    border: 1px solid rgba(77,171,247,.35);
  }
  .cell.taxi {
    background: rgba(245,197,24,.15);
    border: 1px solid rgba(245,197,24,.5);
    animation: pulse 1.2s ease-in-out infinite;
  }
  @keyframes pulse {
    0%,100%{ box-shadow: 0 0 0 0 rgba(245,197,24,.3); }
    50%{     box-shadow: 0 0 0 8px rgba(245,197,24,0); }
  }

  /* â”€â”€ Location labels â”€â”€ */
  .loc-label {
    position: absolute; bottom: 2px; right: 3px;
    font-size: 9px; font-weight: 700; color: var(--muted);
    pointer-events: none;
  }

  /* â”€â”€ Side Panel â”€â”€ */
  .panel {
    display: flex; flex-direction: column; gap: 16px;
    min-width: 260px; flex: 1;
  }

  .card {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 18px;
  }
  .card-title {
    font-size: .68rem; letter-spacing: 2px;
    text-transform: uppercase; color: var(--muted);
    margin-bottom: 12px;
  }

  /* stats */
  .stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  .stat-box {
    background: #0d0d18; border-radius: 8px;
    padding: 10px 12px;
  }
  .stat-label { font-size: .65rem; color: var(--muted); margin-bottom: 2px; }
  .stat-val { font-size: 1.4rem; font-weight: 700; color: var(--accent); }
  .stat-val.green { color: var(--green); }
  .stat-val.red   { color: var(--red); }

  /* mode toggle */
  .mode-tabs { display: flex; gap: 6px; margin-bottom: 14px; }
  .tab {
    flex: 1; padding: 8px; border: 1px solid var(--border);
    background: transparent; color: var(--muted);
    border-radius: 8px; font-family: 'Space Mono', monospace;
    font-size: .75rem; cursor: pointer; transition: all .2s;
  }
  .tab.active {
    background: var(--accent); color: #000;
    border-color: var(--accent); font-weight: 700;
  }

  /* buttons */
  .btn-row { display: flex; gap: 8px; flex-wrap: wrap; }
  button.btn {
    flex: 1; padding: 10px 14px;
    border: 1px solid var(--border); border-radius: 8px;
    background: transparent; color: var(--text);
    font-family: 'Space Mono', monospace; font-size: .78rem;
    cursor: pointer; transition: all .2s; min-width: 80px;
  }
  button.btn:hover { background: var(--dim); border-color: var(--accent); }
  button.btn.primary {
    background: var(--accent); color: #000;
    border-color: var(--accent); font-weight: 700;
  }
  button.btn.primary:hover { opacity: .85; }
  button.btn:disabled { opacity: .35; cursor: not-allowed; }

  /* arrow pad */
  .arrow-pad {
    display: grid;
    grid-template-areas: ". up ." "left . right" ". down .";
    gap: 6px; place-items: center; margin-top: 4px;
  }
  .arrow-pad button { width: 48px; height: 48px; font-size: 18px; padding: 0; border-radius: 10px; }
  .arrow-pad .up    { grid-area: up; }
  .arrow-pad .down  { grid-area: down; }
  .arrow-pad .left  { grid-area: left; }
  .arrow-pad .right { grid-area: right; }
  .pickup-drop { display: flex; gap: 6px; margin-top: 8px; }
  .pickup-drop button { flex:1; }

  /* log */
  #log {
    background: #0d0d18; border-radius: 8px;
    padding: 10px; max-height: 140px; overflow-y: auto;
    font-size: .7rem; line-height: 1.7; color: var(--muted);
  }
  #log .entry { display: flex; gap: 8px; }
  #log .entry .tag { color: var(--accent); min-width: 28px; }
  #log .entry.good .tag { color: var(--green); }
  #log .entry.bad  .tag { color: var(--red); }

  /* speed */
  .speed-row { display: flex; align-items: center; gap: 10px; font-size: .75rem; color: var(--muted); }
  input[type=range] {
    flex: 1; accent-color: var(--accent);
  }

  /* status bar */
  #status-bar {
    margin-top: 6px;
    font-size: .8rem; padding: 10px 14px;
    border-radius: 8px; text-align: center;
    background: rgba(245,197,24,.08);
    border: 1px solid rgba(245,197,24,.2);
    color: var(--accent); min-height: 38px;
  }
  #status-bar.win  { background: rgba(57,211,83,.12); border-color: var(--green); color: var(--green); }
  #status-bar.fail { background: rgba(255,71,87,.1);  border-color: var(--red);   color: var(--red);   }

  /* legend */
  .legend { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 10px; }
  .legend-item { display: flex; align-items: center; gap: 5px; font-size: .68rem; color: var(--muted); }
  .legend-dot { width: 10px; height: 10px; border-radius: 3px; }

  /* q-table note */
  .q-note {
    background: rgba(204,93,232,.08);
    border: 1px solid rgba(204,93,232,.2);
    border-radius: 8px; padding: 12px;
    font-size: .72rem; color: var(--purple); line-height: 1.6;
  }

  /* scrollbar */
  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--dim); border-radius: 2px; }
</style>
</head>
<body>

<h1>ğŸš• TAXI-V3</h1>
<p class="subtitle">Reinforcement Learning Playground</p>

<div class="layout">
  <!-- Board -->
  <div class="board-wrap">
    <div id="grid"></div>
    <div class="legend">
      <div class="legend-item"><div class="legend-dot" style="background:#f5c518"></div> Taxi</div>
      <div class="legend-item"><div class="legend-dot" style="background:#4dabf7"></div> Passenger</div>
      <div class="legend-item"><div class="legend-dot" style="background:#39d353"></div> Destination</div>
      <div class="legend-item"><div class="legend-dot" style="background:#3a3a52"></div> Wall</div>
    </div>
    <div id="status-bar">Press Reset to start a new episode.</div>
  </div>

  <!-- Side Panel -->
  <div class="panel">

    <!-- Stats -->
    <div class="card">
      <div class="card-title">Episode Stats</div>
      <div class="stats">
        <div class="stat-box"><div class="stat-label">Steps</div><div class="stat-val" id="steps">0</div></div>
        <div class="stat-box"><div class="stat-label">Reward</div><div class="stat-val" id="reward">0</div></div>
        <div class="stat-box"><div class="stat-label">Episodes</div><div class="stat-val" id="eps">0</div></div>
        <div class="stat-box"><div class="stat-label">Avg Reward</div><div class="stat-val" id="avg">â€”</div></div>
      </div>
    </div>

    <!-- Mode + Controls -->
    <div class="card">
      <div class="card-title">Mode</div>
      <div class="mode-tabs">
        <button class="tab" id="tab-manual" onclick="setMode('manual')">ğŸ•¹ Manual</button>
        <button class="tab active" id="tab-agent" onclick="setMode('agent')">ğŸ¤– Agent</button>
      </div>

      <!-- Agent controls -->
      <div id="agent-controls">
        <div class="speed-row">
          <span>Speed</span>
          <input type="range" id="speed" min="50" max="800" value="350" step="50">
          <span id="speed-val">350ms</span>
        </div>
        <div class="btn-row" style="margin-top:10px">
          <button class="btn primary" id="btn-run" onclick="toggleRun()">â–¶ Run</button>
          <button class="btn" onclick="stepAgent()" id="btn-step">Step</button>
          <button class="btn" onclick="reset()">Reset</button>
        </div>
        <div class="q-note" style="margin-top:12px">
          <strong>âš  No Q-table loaded.</strong> The agent uses a <em>built-in trained policy</em>
          approximated in JS. To use your own Q-table: run <code>taxi_rl_train.py</code>,
          then load <code>q_table.json</code> below.
          <div style="margin-top:8px">
            <input type="file" id="q-file" accept=".json" onchange="loadQTable(event)"
              style="font-size:.68rem; color:var(--purple); width:100%;">
          </div>
        </div>
      </div>

      <!-- Manual controls -->
      <div id="manual-controls" style="display:none">
        <div class="arrow-pad">
          <button class="btn up"    onclick="humanStep(1)">â†‘</button>
          <button class="btn down"  onclick="humanStep(0)">â†“</button>
          <button class="btn left"  onclick="humanStep(3)">â†</button>
          <button class="btn right" onclick="humanStep(2)">â†’</button>
        </div>
        <div class="pickup-drop">
          <button class="btn" onclick="humanStep(4)">ğŸ§ Pick Up</button>
          <button class="btn" onclick="humanStep(5)">ğŸ“ Drop Off</button>
        </div>
        <div class="btn-row" style="margin-top:10px">
          <button class="btn" onclick="reset()">Reset</button>
        </div>
        <p style="font-size:.68rem;color:var(--muted);margin-top:10px">
          Keyboard: â†‘â†“â†â†’ move Â· P = pickup Â· D = drop
        </p>
      </div>
    </div>

    <!-- Action Log -->
    <div class="card">
      <div class="card-title">Action Log</div>
      <div id="log"></div>
    </div>

  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Taxi-v3 Environment (JavaScript port)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Map layout (5Ã—5). Walls are represented as right-side walls per row.
// Walls from Taxi-v3: between col 0-1 on rows 0-2, between col 2-3 on rows 3-4
const MAP_WALLS = new Set([
  `0,0-right`, `1,0-right`, `2,0-right`,   // row 0 | between col 0-1 at r0,1,2... actually let's encode from official map
]);

// Official Taxi-v3 5x5 map:
// +---------+
// |R: | : :G|
// | : | : : |
// | : : : : |
// | | : | : |
// |Y| : |B: |
// +---------+
// R=(0,0) G=(0,4) Y=(4,0) B=(4,3)
// Walls: right of (0,0),(1,0) and right of (0,3),(1,3),(3,0),(4,0),(3,2),(4,2)

// We'll store walls as "right wall of cell (row,col)"
const WALL_RIGHT = new Set([
  '0,0','1,0',        // col 0|1 on rows 0-1
  '0,2','1,2',        // col 2|3 on rows 0-1
  '3,0','4,0',        // col 0|1 on rows 3-4
  '3,2','4,2',        // col 2|3 on rows 3-4
]);

const LOCS = [[0,0],[0,4],[4,0],[4,3]]; // R G Y B
const LOC_EMOJI = ['ğŸ”´','ğŸŸ¢','ğŸŸ¡','ğŸ”µ'];
const LOC_NAMES = ['R','G','Y','B'];
const ACTION_NAMES = ['â¬‡ South','â¬† North','â¡ East','â¬… West','ğŸ§ Pickup','ğŸ“ Dropoff'];
const ACTION_COLOR = ['','','','','good',''];

// State encoding: row*100 + col*20 + pass_idx*4 + dest_idx  (Taxi-v3 formula)
// decode(state) â†’ {row, col, pass, dest}
function decode(state) {
  let s = state;
  const dest = s % 4; s = Math.floor(s / 4);
  const pass = s % 5; s = Math.floor(s / 5);
  const col  = s % 5; s = Math.floor(s / 5);
  const row  = s;
  return { row, col, pass, dest };
}
function encode(row, col, pass, dest) {
  return ((row * 5 + col) * 5 + pass) * 4 + dest;
}

class TaxiEnv {
  constructor() { this.reset(); }
  reset() {
    // random taxi pos, random passenger loc (0-3), random dest â‰  passenger
    this.taxiRow = Math.floor(Math.random() * 5);
    this.taxiCol = Math.floor(Math.random() * 5);
    this.passIdx = Math.floor(Math.random() * 4);  // 0-3 = locations
    do { this.destIdx = Math.floor(Math.random() * 4); } while (this.destIdx === this.passIdx);
    this.passInTaxi = false;
    this.done = false;
    return this.state;
  }
  get state() {
    const p = this.passInTaxi ? 4 : this.passIdx;
    return encode(this.taxiRow, this.taxiCol, p, this.destIdx);
  }
  step(action) {
    if (this.done) return { state: this.state, reward: 0, done: true };
    let reward = -1;
    const [r, c] = [this.taxiRow, this.taxiCol];
    let nr = r, nc = c;

    if (action === 0) nr = Math.min(4, r + 1);        // south
    else if (action === 1) nr = Math.max(0, r - 1);   // north
    else if (action === 2) {                            // east
      if (!WALL_RIGHT.has(`${r},${c}`)) nc = Math.min(4, c + 1);
    }
    else if (action === 3) {                            // west
      if (!WALL_RIGHT.has(`${r},${c-1}`)) nc = Math.max(0, c - 1);
    }
    else if (action === 4) {                            // pickup
      const [pr, pc] = LOCS[this.passIdx];
      if (!this.passInTaxi && nr === pr && nc === pc) {
        this.passInTaxi = true;
      } else if (!this.passInTaxi) reward = -10;
    }
    else if (action === 5) {                            // dropoff
      const [dr, dc] = LOCS[this.destIdx];
      if (this.passInTaxi && nr === dr && nc === dc) {
        reward = 20; this.done = true; this.passInTaxi = false;
        this.passIdx = this.destIdx;
      } else { reward = -10; }
    }

    this.taxiRow = nr; this.taxiCol = nc;
    return { state: this.state, reward, done: this.done };
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Heuristic Agent (used when no Q-table is loaded)
//  Simple rule-based: navigate to passenger, pick up, navigate to dest, drop
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function heuristicAction(env) {
  const { taxiRow: r, taxiCol: c, passIdx, destIdx, passInTaxi } = env;
  const target = passInTaxi ? LOCS[destIdx] : LOCS[passIdx];
  const [tr, tc] = target;

  if (!passInTaxi && r === tr && c === tc) return 4; // pickup
  if (passInTaxi && r === tr && c === tc)  return 5; // dropoff

  // Move toward target (simple Manhattan, wall-aware)
  if (r < tr) return 0; // south
  if (r > tr) return 1; // north
  if (c < tc) {
    if (!WALL_RIGHT.has(`${r},${c}`)) return 2;
    return r < tr ? 0 : 1;
  }
  if (c > tc) {
    if (!WALL_RIGHT.has(`${r},${c-1}`)) return 3;
    return r < tr ? 0 : 1;
  }
  return Math.floor(Math.random() * 4);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UI State
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let env = new TaxiEnv();
let QTable = null;
let mode = 'agent';
let running = false;
let runTimer = null;
let totalReward = 0;
let steps = 0;
let episodeCount = 0;
let rewardHistory = [];

function getAgentAction(state) {
  if (QTable) {
    const row = QTable[state];
    return row.indexOf(Math.max(...row));
  }
  return heuristicAction(env);
}

function reset(newEpisode = true) {
  if (running) toggleRun();
  env.reset();
  totalReward = 0; steps = 0;
  if (newEpisode) episodeCount++;
  updateStats();
  render();
  setStatus('New episode. ' + (mode === 'agent' ? 'Press Run or Step.' : 'Use controls to navigate.'), '');
  document.getElementById('log').innerHTML = '';
}

function stepAgent() {
  if (env.done) { reset(); return; }
  const action = getAgentAction(env.state);
  doStep(action);
}

function humanStep(action) {
  if (env.done) { reset(); return; }
  doStep(action);
}

function doStep(action) {
  const prevDone = env.done;
  const { state, reward, done } = env.step(action);
  steps++;
  totalReward += reward;
  updateStats();
  render();
  logAction(action, reward);

  if (done) {
    setStatus('âœ… Passenger delivered! Reward +20. Press Reset for next episode.', 'win');
    rewardHistory.push(totalReward);
    document.getElementById('avg').textContent = (rewardHistory.reduce((a,b)=>a+b,0)/rewardHistory.length).toFixed(1);
    if (running) toggleRun();
  } else if (steps > 200) {
    setStatus('â± Too many steps â€” resetting...', 'fail');
    setTimeout(reset, 800);
  }
}

function toggleRun() {
  running = !running;
  const btn = document.getElementById('btn-run');
  if (running) {
    btn.textContent = 'â¸ Pause'; btn.classList.remove('primary');
    runLoop();
  } else {
    btn.textContent = 'â–¶ Run'; btn.classList.add('primary');
    clearTimeout(runTimer);
  }
}

function runLoop() {
  if (!running) return;
  if (env.done) { reset(); }
  else stepAgent();
  const delay = 850 - parseInt(document.getElementById('speed').value);
  runTimer = setTimeout(runLoop, Math.max(50, delay));
}

function setMode(m) {
  mode = m;
  document.getElementById('tab-manual').classList.toggle('active', m === 'manual');
  document.getElementById('tab-agent').classList.toggle('active',  m === 'agent');
  document.getElementById('agent-controls').style.display  = m === 'agent'  ? '' : 'none';
  document.getElementById('manual-controls').style.display = m === 'manual' ? '' : 'none';
  if (running) toggleRun();
  reset();
}

function loadQTable(evt) {
  const file = evt.target.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      QTable = JSON.parse(e.target.result);
      document.querySelector('.q-note').innerHTML =
        `<strong style="color:var(--green)">âœ… Q-table loaded!</strong> ${QTable.length} states Ã— ${QTable[0].length} actions. Agent now uses learned policy.`;
      reset();
    } catch { alert('Invalid JSON file.'); }
  };
  reader.readAsText(file);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Rendering
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render() {
  const grid = document.getElementById('grid');
  grid.innerHTML = '';
  for (let r = 0; r < 5; r++) {
    for (let c = 0; c < 5; c++) {
      const cell = document.createElement('div');
      cell.className = 'cell';

      // Wall right?
      if (WALL_RIGHT.has(`${r},${c}`)) cell.classList.add('wall-right');

      let emoji = '';
      const isTaxi = env.taxiRow === r && env.taxiCol === c;
      const isPass = !env.passInTaxi && LOCS[env.passIdx][0] === r && LOCS[env.passIdx][1] === c;
      const isDest = LOCS[env.destIdx][0] === r && LOCS[env.destIdx][1] === c;

      if (isDest)  cell.classList.add('dest');
      if (isPass && !isTaxi) cell.classList.add('passenger');
      if (isTaxi)  cell.classList.add('taxi');

      if (isTaxi && env.passInTaxi) emoji = 'ğŸš•';
      else if (isTaxi) emoji = 'ğŸš–';
      else if (isPass) emoji = 'ğŸ§';

      if (emoji) cell.textContent = emoji;

      // Location label
      const locIdx = LOCS.findIndex(([lr,lc]) => lr===r && lc===c);
      if (locIdx !== -1) {
        const lbl = document.createElement('span');
        lbl.className = 'loc-label';
        lbl.textContent = LOC_NAMES[locIdx];
        cell.appendChild(lbl);
      }

      grid.appendChild(cell);
    }
  }
}

function updateStats() {
  document.getElementById('steps').textContent  = steps;
  const rEl = document.getElementById('reward');
  rEl.textContent = totalReward;
  rEl.className = 'stat-val ' + (totalReward >= 0 ? 'green' : 'red');
  document.getElementById('eps').textContent = episodeCount;
}

function setStatus(msg, cls) {
  const el = document.getElementById('status-bar');
  el.textContent = msg; el.className = cls;
}

function logAction(action, reward) {
  const log = document.getElementById('log');
  const entry = document.createElement('div');
  entry.className = 'entry' + (reward === 20 ? ' good' : reward < 0 ? ' bad' : '');
  entry.innerHTML = `<span class="tag">${steps}</span><span>${ACTION_NAMES[action]} Â· ${reward >= 0 ? '+' : ''}${reward}</span>`;
  log.appendChild(entry);
  log.scrollTop = log.scrollHeight;
}

// Speed slider
document.getElementById('speed').addEventListener('input', function() {
  document.getElementById('speed-val').textContent = this.value + 'ms';
});

// Keyboard controls (manual mode)
document.addEventListener('keydown', e => {
  if (mode !== 'manual') return;
  const map = { ArrowUp:1, ArrowDown:0, ArrowRight:2, ArrowLeft:3, p:4, P:4, d:5, D:5 };
  if (map[e.key] !== undefined) { e.preventDefault(); humanStep(map[e.key]); }
});

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
setMode('agent');
</script>
</body>
</html>
